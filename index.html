<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calcium</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/base16/green-screen.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
<style>
html { font-size: 15px; }

:root {
  --bg:       #080c10;
  --bg2:      #0c1118;
  --bg3:      #101820;
  --bg4:      #141e28;
  --border:   rgba(0, 200, 255, 0.12);
  --border2:  rgba(0, 200, 255, 0.22);
  --cyan:     #00ccff;
  --cyan-dim: #0088bb;
  --cyan-glow:rgba(0,200,255,0.12);
  --red:      #ff3355;
  --orange:   #ff9900;
  --green:    #00ff88;
  --green-dim:#00aa55;
  --text:     #b8d8e8;
  --text-dim: rgba(180,220,240,0.45);
  --mono:     'JetBrains Mono', monospace;
  --display:  'Rajdhani', sans-serif;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--mono);
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* Subtle scanline */
body::after {
  content:'';
  position:fixed; inset:0;
  background: repeating-linear-gradient(0deg, transparent, transparent 3px, rgba(0,0,0,0.04) 3px, rgba(0,0,0,0.04) 4px);
  pointer-events:none;
  z-index:9999;
}

/* ── SCROLLBARS ── */
::-webkit-scrollbar { width:4px; height:4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(0,200,255,0.2); border-radius:2px; }
::-webkit-scrollbar-thumb:hover { background: rgba(0,200,255,0.4); }

/* ── HEADER ── */
header {
  height: 48px;
  padding: 0 18px;
  border-bottom: 1px solid var(--border);
  background: var(--bg2);
  display: flex;
  align-items: center;
  gap: 14px;
  flex-shrink: 0;
}

.logo {
  font-family: var(--display);
  font-size: 1.6rem;
  font-weight: 700;
  color: var(--cyan);
  letter-spacing: 3px;
  text-shadow: 0 0 20px rgba(0,200,255,0.5);
}
.logo em { color: rgba(0,200,255,0.45); font-style:normal; }

.status-badge {
  display:flex; align-items:center; gap:6px;
  font-size:0.72rem; color:var(--green); letter-spacing:2px;
  text-transform:uppercase;
}
.status-dot {
  width:6px; height:6px; border-radius:50%;
  background:var(--green); box-shadow:0 0 8px var(--green);
  animation: pulse 2s infinite;
}
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

.header-right { margin-left:auto; display:flex; gap:8px; align-items:center; }

.hbtn {
  background:transparent;
  border:1px solid var(--border2);
  color:var(--cyan-dim);
  font-family:var(--mono);
  font-size:0.75rem;
  padding:5px 14px;
  cursor:pointer;
  letter-spacing:1px;
  transition:all 0.15s;
  text-transform:uppercase;
}
.hbtn:hover { border-color:var(--cyan); color:var(--cyan); background:var(--cyan-glow); }

/* ── MAIN LAYOUT ── */
.main { display:flex; flex:1; overflow:hidden; }

/* ── SIDEBAR ── */
.sidebar {
  width:30%;
  min-width:220px;
  max-width:320px;
  border-right:1px solid var(--border);
  background:var(--bg2);
  display:flex;
  flex-direction:column;
  overflow:hidden;
}

.sidebar-head {
  padding:10px 12px 6px;
  border-bottom:1px solid var(--border);
  flex-shrink:0;
}

.sidebar-title {
  font-family:var(--display);
  font-size:0.75rem;
  font-weight:600;
  color:var(--cyan-dim);
  letter-spacing:3px;
  text-transform:uppercase;
  margin-bottom:8px;
}

.search-wrap {
  position:relative;
}
.search-wrap::before {
  content:'›';
  position:absolute; left:8px; top:50%; transform:translateY(-50%);
  color:var(--cyan-dim); font-size:1rem; pointer-events:none;
}
#toolSearch {
  width:100%;
  background:var(--bg3);
  border:1px solid var(--border);
  color:var(--cyan);
  font-family:var(--mono);
  font-size:0.82rem;
  padding:6px 8px 6px 22px;
  outline:none;
  transition:border 0.15s;
}
#toolSearch::placeholder { color:var(--text-dim); }
#toolSearch:focus { border-color:var(--cyan-dim); }

.cat-strip {
  display:flex; flex-wrap:wrap; gap:3px;
  padding:6px 10px;
  border-bottom:1px solid var(--border);
  flex-shrink:0;
  background:var(--bg2);
}
.cat-btn {
  background:transparent;
  border:1px solid rgba(0,200,255,0.1);
  color:rgba(0,200,255,0.35);
  font-family:var(--mono);
  font-size:0.68rem;
  padding:3px 7px;
  cursor:pointer;
  letter-spacing:0.5px;
  transition:all 0.12s;
  text-transform:uppercase;
}
.cat-btn:hover, .cat-btn.active {
  border-color:var(--cyan);
  color:var(--cyan);
  background:var(--cyan-glow);
}

.tools-list {
  flex:1;
  overflow-y:auto;
  padding:4px 0;
}

.tool-cat-hdr {
  font-family:var(--display);
  font-size:0.68rem;
  font-weight:600;
  color:rgba(0,200,255,0.3);
  letter-spacing:3px;
  padding:8px 12px 3px;
  text-transform:uppercase;
}

.tool-item {
  padding:5px 12px;
  cursor:pointer;
  border-left:2px solid transparent;
  transition:all 0.12s;
}
.tool-item:hover {
  background:rgba(0,200,255,0.06);
  border-left-color:var(--cyan);
}
.tool-name {
  font-size:0.85rem;
  color:var(--cyan);
  font-weight:600;
}
.tool-name::before { content:'$ '; color:rgba(0,200,255,0.25); font-weight:400; }
.tool-desc {
  font-size:0.73rem;
  color:var(--text-dim);
  margin-top:1px;
  line-height:1.35;
}
.no-results {
  text-align:center;
  color:var(--text-dim);
  font-size:0.78rem;
  padding:20px;
  font-style:italic;
}

/* ── CONTENT AREA ── */
.content { display:flex; flex:1; overflow:hidden; }

/* ── TERMINAL COLUMN ── */
.term-col {
  width:50%;
  border-right:1px solid var(--border);
  display:flex;
  flex-direction:column;
  overflow:hidden;
  background:var(--bg);
}

.col-hdr {
  height:36px;
  padding:0 14px;
  border-bottom:1px solid var(--border);
  background:var(--bg2);
  display:flex;
  align-items:center;
  gap:8px;
  flex-shrink:0;
}
.col-hdr-dot { width:5px; height:5px; border-radius:50%; }
.col-hdr-title {
  font-family:var(--display);
  font-size:0.75rem;
  font-weight:600;
  letter-spacing:3px;
  text-transform:uppercase;
}
.term-col .col-hdr-dot { background:#00ccff; box-shadow:0 0 6px #00ccff; }
.term-col .col-hdr-title { color:#00ccff; }
.chat-col .col-hdr-dot { background:var(--green); box-shadow:0 0 6px var(--green); }
.chat-col .col-hdr-title { color:var(--green); }

/* Top pane */
.term-top {
  flex:1;
  display:flex;
  flex-direction:column;
  overflow:hidden;
  border-bottom:1px solid rgba(0,200,255,0.2);
}
.pane-hdr {
  height:26px;
  padding:0 14px;
  display:flex;
  align-items:center;
  gap:6px;
  border-bottom:1px solid var(--border);
  background:rgba(0,200,255,0.03);
  flex-shrink:0;
}
.pane-hdr-dot { width:4px; height:4px; border-radius:50%; }
.pane-hdr-label {
  font-size:0.65rem;
  color:var(--text-dim);
  letter-spacing:2px;
  text-transform:uppercase;
}

#termOutput {
  flex:1;
  overflow-y:auto;
  padding:10px 14px;
  display:flex;
  flex-direction:column;
  gap:8px;
}

.term-welcome {
  color:rgba(0,200,255,0.22);
  font-size:0.82rem;
  line-height:1.9;
  padding:4px 0;
}

.term-entry { animation:fadeUp 0.2s ease; }
@keyframes fadeUp { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:translateY(0)} }

.term-cmd {
  font-size:0.88rem;
  color:#44ddff;
  margin-bottom:3px;
}
.term-cmd::before { content:'$ '; color:rgba(0,200,255,0.4); }

.term-out {
  white-space:pre-wrap;
  word-break:break-word;
  color:#90c8e0;
  font-size:0.82rem;
  line-height:1.55;
  padding:7px 10px;
  background:rgba(0,0,0,0.3);
  border-left:2px solid rgba(0,200,255,0.15);
  max-height:220px;
  overflow-y:auto;
}
.term-err { color:var(--red) !important; border-left-color:var(--red) !important; }
.term-running { color:var(--text-dim); font-style:italic; font-size:0.78rem; }

.term-input-row {
  padding:8px 14px;
  border-top:1px solid var(--border);
  background:var(--bg2);
  display:flex;
  gap:8px;
  align-items:center;
  flex-shrink:0;
}
.term-prompt { color:#44ddff; font-size:0.95rem; flex-shrink:0; }

#cmdInput {
  flex:1;
  background:transparent;
  border:none;
  border-bottom:1px solid rgba(0,200,255,0.2);
  color:#44ddff;
  font-family:var(--mono);
  font-size:0.88rem;
  padding:2px 0;
  outline:none;
  transition:border 0.15s;
}
#cmdInput::placeholder { color:rgba(0,200,255,0.2); }
#cmdInput:focus { border-bottom-color:rgba(0,200,255,0.6); }

.run-btn {
  background:transparent;
  border:1px solid rgba(0,200,255,0.3);
  color:#44ddff;
  font-family:var(--mono);
  font-size:0.78rem;
  padding:4px 12px;
  cursor:pointer;
  letter-spacing:1px;
  transition:all 0.15s;
  text-transform:uppercase;
}
.run-btn:hover { border-color:#44ddff; background:rgba(0,200,255,0.08); box-shadow:0 0 8px rgba(0,200,255,0.2); }
.run-btn:disabled { opacity:0.3; cursor:not-allowed; }

/* Bottom pane: log */
.term-bottom {
  flex:1;
  display:flex;
  flex-direction:column;
  overflow:hidden;
  background:rgba(0,0,0,0.2);
}

#activityLog {
  flex:1;
  overflow-y:auto;
  padding:5px 10px;
  display:flex;
  flex-direction:column;
  gap:1px;
  font-size:0.78rem;
}

.log-row {
  display:flex;
  align-items:flex-start;
  gap:7px;
  padding:2px 4px;
  border-bottom:1px solid rgba(0,200,255,0.03);
  animation:fadeUp 0.15s ease;
  line-height:1.45;
}
.log-ts { color:rgba(0,200,255,0.25); flex-shrink:0; font-size:0.7rem; min-width:56px; }
.log-tag {
  flex-shrink:0;
  font-size:0.65rem;
  padding:1px 5px;
  border-radius:2px;
  font-weight:700;
  letter-spacing:0.5px;
  min-width:32px;
  text-align:center;
  text-transform:uppercase;
}
.log-tag.cmd  { background:rgba(0,200,255,0.12);  color:#44ddff; }
.log-tag.ok   { background:rgba(0,255,100,0.1);   color:#44ff88; }
.log-tag.err  { background:rgba(255,50,80,0.12);  color:#ff4466; }
.log-tag.ai   { background:rgba(0,200,255,0.08);  color:#00ccff; }
.log-tag.info { background:rgba(255,160,0,0.1);   color:#ffaa00; }
.log-text { color:rgba(180,220,240,0.55); flex:1; word-break:break-word; font-size:0.75rem; }

/* ── CHAT COLUMN ── */
.chat-col { flex:1; display:flex; flex-direction:column; overflow:hidden; }

#messages {
  flex:1;
  overflow-y:auto;
  padding:14px;
  display:flex;
  flex-direction:column;
  gap:12px;
  scroll-behavior:smooth;
}

.welcome {
  text-align:center;
  padding:28px 16px;
  color:rgba(0,200,255,0.25);
}
.welcome-art {
  font-size:0.72rem;
  line-height:1.3;
  white-space:pre;
  color:rgba(0,200,255,0.1);
  margin-bottom:14px;
}
.welcome h2 {
  font-family:var(--display);
  font-size:1.0rem;
  font-weight:700;
  letter-spacing:4px;
  color:rgba(0,200,255,0.4);
  text-transform:uppercase;
  margin-bottom:8px;
}
.welcome p {
  font-size:0.8rem;
  line-height:1.8;
  color:var(--text-dim);
}

.msg {
  display:flex;
  gap:10px;
  animation:fadeUp 0.25s ease;
}
.msg-icon {
  width:26px; height:26px;
  border:1px solid var(--border2);
  display:flex; align-items:center; justify-content:center;
  font-size:0.85rem;
  flex-shrink:0;
  margin-top:2px;
}
.user-msg .msg-icon { color:#44ddff; border-color:rgba(0,200,255,0.3); }
.ai-msg .msg-icon { color:var(--green); border-color:rgba(0,255,136,0.2); box-shadow:0 0 8px rgba(0,255,136,0.1); }

.msg-inner { flex:1; min-width:0; }
.msg-meta {
  font-size:0.68rem;
  color:var(--cyan-dim);
  margin-bottom:5px;
  letter-spacing:1px;
  text-transform:uppercase;
}
.msg-body {
  font-size:0.9rem;
  line-height:1.7;
  color:var(--text);
}
.user-msg .msg-body { color:#c8e8f8; }

.msg-body h1,.msg-body h2,.msg-body h3 {
  font-family:var(--display);
  color:var(--cyan);
  margin:10px 0 4px;
  font-size:0.95rem;
  font-weight:700;
  letter-spacing:1px;
}
.msg-body code {
  background:var(--bg3);
  color:var(--cyan);
  padding:1px 5px;
  font-family:var(--mono);
  font-size:0.83rem;
  border:1px solid var(--border);
}
.msg-body pre {
  background:var(--bg3);
  border:1px solid var(--border);
  padding:10px 12px;
  margin:7px 0;
  overflow-x:auto;
  position:relative;
}
.msg-body pre code {
  background:none; border:none; padding:0;
  color:var(--green);
  font-size:0.82rem;
}
.copy-btn {
  position:absolute; top:5px; right:5px;
  background:var(--bg); border:1px solid var(--border);
  color:var(--text-dim);
  font-family:var(--mono);
  font-size:0.65rem;
  padding:2px 7px;
  cursor:pointer;
  transition:all 0.15s;
  text-transform:uppercase;
  letter-spacing:0.5px;
}
.copy-btn:hover { color:var(--cyan); border-color:var(--cyan); }

.msg-body ul,.msg-body ol { padding-left:16px; margin:5px 0; }
.msg-body li { margin-bottom:3px; }
.msg-body strong { color:var(--cyan); }
.msg-body a { color:var(--cyan-dim); text-decoration:underline; }
.msg-body p { margin-bottom:6px; }

.typing { display:flex; gap:5px; align-items:center; padding:4px 0; }
.typing span {
  width:5px; height:5px;
  background:var(--green);
  border-radius:50%;
  animation:blink 1.2s infinite;
}
.typing span:nth-child(2) { animation-delay:0.2s; }
.typing span:nth-child(3) { animation-delay:0.4s; }
@keyframes blink { 0%,100%{opacity:0.2} 50%{opacity:1} }

.chat-input-row {
  padding:10px 14px;
  border-top:1px solid var(--border);
  background:var(--bg2);
  display:flex;
  gap:8px;
  flex-shrink:0;
  align-items:flex-end;
}
#userInput {
  flex:1;
  background:var(--bg3);
  border:1px solid var(--border);
  color:var(--text);
  font-family:var(--mono);
  font-size:0.88rem;
  padding:8px 12px;
  outline:none;
  resize:none;
  height:38px;
  line-height:1.5;
  transition:border 0.15s;
}
#userInput:focus { border-color:rgba(0,200,255,0.4); }
#userInput::placeholder { color:var(--text-dim); }

.send-btn {
  background:rgba(0,200,255,0.08);
  border:1px solid var(--cyan-dim);
  color:var(--cyan);
  font-family:var(--display);
  font-size:0.82rem;
  font-weight:700;
  padding:0 18px;
  height:38px;
  cursor:pointer;
  letter-spacing:2px;
  transition:all 0.15s;
  text-transform:uppercase;
  flex-shrink:0;
}
.send-btn:hover {
  background:var(--cyan);
  color:var(--bg);
  box-shadow:0 0 16px rgba(0,200,255,0.3);
}
.send-btn:disabled { opacity:0.35; cursor:not-allowed; }

  /* ── ADMIN MODAL ── */
  .modal-overlay {
    display:none; position:fixed; inset:0;
    background:rgba(0,0,0,0.75);
    z-index:9000; align-items:center; justify-content:center;
  }
  .modal-overlay.open { display:flex; }
  .modal {
    background:var(--bg2);
    border:1px solid var(--border2);
    width:100%; max-width:540px;
    max-height:80vh;
    display:flex; flex-direction:column;
    box-shadow:0 0 60px rgba(0,200,255,0.1);
    animation:fadeUp 0.2s ease;
  }
  .modal-head {
    padding:14px 20px;
    border-bottom:1px solid var(--border);
    display:flex; align-items:center; justify-content:space-between;
    flex-shrink:0;
  }
  .modal-title {
    font-family:var(--display);
    font-size:0.85rem; font-weight:700;
    color:var(--cyan); letter-spacing:3px; text-transform:uppercase;
  }
  .modal-close {
    background:transparent; border:1px solid var(--border);
    color:var(--text); font-family:var(--mono);
    font-size:0.75rem; padding:3px 10px; cursor:pointer;
    transition:all 0.15s;
  }
  .modal-close:hover { border-color:var(--red); color:var(--red); }
  .modal-body { padding:20px; overflow-y:auto; flex:1; }
  .modal-section { margin-bottom:20px; }
  .modal-section-title {
    font-size:0.65rem; color:var(--dim);
    letter-spacing:2px; text-transform:uppercase;
    margin-bottom:10px; padding-bottom:5px;
    border-bottom:1px solid var(--border);
  }
  .modal-row { display:flex; gap:8px; margin-bottom:8px; }
  .modal-input {
    flex:1; background:var(--bg3); border:1px solid var(--border);
    color:var(--text); font-family:var(--mono); font-size:0.82rem;
    padding:7px 10px; outline:none; transition:border 0.15s;
  }
  .modal-input:focus { border-color:rgba(0,200,255,0.4); }
  .modal-input::placeholder { color:var(--text-dim); }
  .modal-select {
    background:var(--bg3); border:1px solid var(--border);
    color:var(--text); font-family:var(--mono); font-size:0.82rem;
    padding:7px 10px; outline:none; cursor:pointer; min-width:90px;
  }
  .modal-btn {
    background:rgba(0,200,255,0.08); border:1px solid var(--cyan-dim);
    color:var(--cyan); font-family:var(--mono); font-size:0.75rem;
    padding:7px 14px; cursor:pointer; letter-spacing:1px;
    transition:all 0.15s; text-transform:uppercase; white-space:nowrap;
  }
  .modal-btn:hover { background:var(--cyan); color:var(--bg); }
  .modal-msg {
    font-size:0.75rem; padding:7px 10px; margin-bottom:10px;
    border-radius:2px; display:none;
  }
  .modal-msg.ok  { background:rgba(0,255,136,0.08); border:1px solid rgba(0,255,136,0.2); color:#00ff88; display:block; }
  .modal-msg.err { background:rgba(255,50,80,0.08); border:1px solid rgba(255,50,80,0.2); color:#ff4466; display:block; }
  .user-table { width:100%; border-collapse:collapse; font-size:0.78rem; }
  .user-table th {
    text-align:left; padding:5px 8px;
    color:var(--dim); font-size:0.62rem; letter-spacing:1px;
    border-bottom:1px solid var(--border); font-weight:normal; text-transform:uppercase;
  }
  .user-table td { padding:7px 8px; border-bottom:1px solid rgba(0,200,255,0.04); }
  .user-table tr:hover td { background:rgba(0,200,255,0.03); }
  .utag {
    font-size:0.6rem; padding:2px 6px; border-radius:10px;
    letter-spacing:0.5px; text-transform:uppercase;
  }
  .utag-admin { background:rgba(255,170,0,0.1); color:#ffaa00; border:1px solid rgba(255,170,0,0.2); }
  .utag-user  { background:rgba(0,200,255,0.08); color:var(--cyan-dim); border:1px solid var(--border); }
  .udel { background:transparent; border:1px solid rgba(255,50,80,0.2); color:rgba(255,80,100,0.5);
    font-family:var(--mono); font-size:0.62rem; padding:2px 7px; cursor:pointer; transition:all 0.15s; }
  .udel:hover { border-color:var(--red); color:var(--red); background:rgba(255,50,80,0.08); }
</style>
</head>
<body>

<header>
  <div class="logo">CAL<em>CIUM</em></div>
  <div class="status-badge"><div class="status-dot"></div>SYSTEM ONLINE</div>
  <div class="header-right">
    <button class="hbtn" id="adminBtn" onclick="openAdmin()" style="display:none">[ ADMIN ]</button>
    <button class="hbtn" onclick="clearSession()">[ CLEAR ]</button>
    <button class="hbtn" onclick="exportSession()">[ EXPORT ]</button>
    <button class="hbtn" id="logoutBtn" onclick="doLogout()" style="border-color:rgba(255,50,80,0.3);color:rgba(255,80,100,0.6);display:none">[ LOGOUT ]</button>
  </div>
</header>

<div class="main">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-head">
      <div class="sidebar-title">⚡ Kali Tools</div>
      <div class="search-wrap">
        <input id="toolSearch" type="text" placeholder="Search tools..." oninput="renderTools()" autocomplete="off">
      </div>
    </div>
    <div class="cat-strip" id="catFilter"></div>
    <div class="tools-list" id="toolsList"></div>
  </div>

  <!-- CONTENT -->
  <div class="content">

    <!-- TERMINAL -->
    <div class="term-col">
      <div class="col-hdr">
        <div class="col-hdr-dot"></div>
        <div class="col-hdr-title">Terminal</div>
      </div>

      <!-- Top: command runner -->
      <div class="term-top">
        <div class="pane-hdr">
          <div class="pane-hdr-dot" style="background:#44ddff"></div>
          <div class="pane-hdr-label">Run Commands</div>
        </div>
        <div id="termOutput">
          <div class="term-welcome">
            ┌──(kali㉿calcium)-[~]<br>
            └─$ Ready — type a command below
          </div>
        </div>
        <div class="term-input-row">
          <span class="term-prompt">$</span>
          <input type="text" id="cmdInput" placeholder="nmap -sV 192.168.1.1"
            onkeydown="handleCmdKey(event)" autocomplete="off" spellcheck="false">
          <button class="run-btn" id="runBtn" onclick="runCommand()">[ RUN ]</button>
        </div>
      </div>

      <!-- Bottom: activity log -->
      <div class="term-bottom">
        <div class="pane-hdr">
          <div class="pane-hdr-dot" style="background:#ffaa00"></div>
          <div class="pane-hdr-label">Activity Log</div>
        </div>
        <div id="activityLog">
          <div class="log-row">
            <span class="log-ts">--:--:--</span>
            <span class="log-tag info">info</span>
            <span class="log-text">Calcium started. All actions will be logged here.</span>
          </div>
        </div>
      </div>
    </div>

    <!-- CHAT -->
    <div class="chat-col">
      <div class="col-hdr">
        <div class="col-hdr-dot"></div>
        <div class="col-hdr-title">AI Chat</div>
      </div>
      <div id="messages">
        <div class="welcome">
          <div class="welcome-art"> ██████╗ █████╗ ██╗      ██████╗██╗
██╔════╝██╔══██╗██║     ██╔════╝██║
██║     ███████║██║     ██║     ██║
██║     ██╔══██║██║     ██║     ██║
╚██████╗██║  ██║███████╗╚██████╗██║
 ╚═════╝╚═╝  ╚═╝╚══════╝ ╚═════╝╚═╝</div>
          
          <p>Browse tools on the left · Run commands in the middle<br>Chat with AI on the right</p>
        </div>
      </div>
      <div class="chat-input-row">
        <textarea id="userInput"
          placeholder="Ask Calcium anything... or paste tool output for analysis"
          onkeydown="handleKey(event)"></textarea>
        <button class="send-btn" id="sendBtn" onclick="sendMessage()">SEND</button>
      </div>
    </div>

  </div>
</div>

<script>
// ═══════════════════════════════════
// KALI TOOLS DATABASE
// ═══════════════════════════════════
const KALI_TOOLS = [
  {n:'nmap',        c:'Recon',    p:'Network mapper — port scanning, OS detection, service versions'},
  {n:'masscan',     c:'Recon',    p:'Fastest mass port scanner — millions of packets/sec'},
  {n:'rustscan',    c:'Recon',    p:'Ultra-fast Rust port scanner, auto-pipes to nmap'},
  {n:'netdiscover', c:'Recon',    p:'ARP scanner for live host discovery on LAN'},
  {n:'arp-scan',    c:'Recon',    p:'ARP host discovery on local network segments'},
  {n:'dnsenum',     c:'Recon',    p:'DNS enumeration — subdomains, zone transfers, MX/NS'},
  {n:'dnsrecon',    c:'Recon',    p:'DNS recon — brute force, reverse lookup, zone transfer'},
  {n:'fierce',      c:'Recon',    p:'DNS reconnaissance and non-contiguous IP scanner'},
  {n:'theHarvester',c:'Recon',    p:'OSINT — emails, subdomains, IPs from public sources'},
  {n:'recon-ng',    c:'Recon',    p:'Full-featured web recon framework with modules'},
  {n:'maltego',     c:'Recon',    p:'Visual OSINT and link analysis data mining tool'},
  {n:'spiderfoot',  c:'Recon',    p:'Automated OSINT — footprinting and threat intel'},
  {n:'subfinder',   c:'Recon',    p:'Passive subdomain discovery via online sources'},
  {n:'amass',       c:'Recon',    p:'In-depth subdomain enumeration and network mapping'},
  {n:'shodan',      c:'Recon',    p:'CLI for internet-connected device search engine'},
  {n:'whois',       c:'Recon',    p:'Query domain registration and IP ownership info'},
  {n:'dig',         c:'Recon',    p:'DNS lookup — query any record type in detail'},
  {n:'dmitry',      c:'Recon',    p:'Info gathering — whois, subdomains, email addresses'},
  {n:'nikto',       c:'Web',      p:'Web server scanner — misconfigs, dangerous files'},
  {n:'gobuster',    c:'Web',      p:'Directory, file and DNS subdomain brute forcer'},
  {n:'dirb',        c:'Web',      p:'Web content scanner using dictionary attacks'},
  {n:'dirsearch',   c:'Web',      p:'Fast web path scanner with advanced filtering'},
  {n:'feroxbuster', c:'Web',      p:'Recursive Rust-based content discovery tool'},
  {n:'ffuf',        c:'Web',      p:'Fast web fuzzer for dirs, parameters, vhosts'},
  {n:'wfuzz',       c:'Web',      p:'Web fuzzer — brute force params, auth, paths'},
  {n:'sqlmap',      c:'Web',      p:'Automated SQL injection detection and exploitation'},
  {n:'gospider',    c:'Web',      p:'Fast web spider — crawl sites and find endpoints'},
  {n:'hakrawler',   c:'Web',      p:'Simple crawler for endpoint and asset discovery'},
  {n:'katana',      c:'Web',      p:'Next-gen crawling and spidering framework'},
  {n:'gau',         c:'Web',      p:'Fetch known URLs from AlienVault, Wayback, URLScan'},
  {n:'waybackurls', c:'Web',      p:'Pull URLs from Wayback Machine for a domain'},
  {n:'burpsuite',   c:'Web',      p:'Integrated web app security testing platform'},
  {n:'zaproxy',     c:'Web',      p:'OWASP ZAP — free web app security scanner/proxy'},
  {n:'whatweb',     c:'Web',      p:'Web fingerprinting — CMS, frameworks, server info'},
  {n:'wafw00f',     c:'Web',      p:'Detect and fingerprint Web Application Firewalls'},
  {n:'wpscan',      c:'Web',      p:'WordPress scanner — plugins, themes, users'},
  {n:'joomscan',    c:'Web',      p:'Joomla CMS vulnerability scanner'},
  {n:'nuclei',      c:'Web',      p:'Fast vuln scanner using community templates'},
  {n:'dalfox',      c:'Web',      p:'Fast XSS scanner and parameter analysis tool'},
  {n:'arjun',       c:'Web',      p:'HTTP parameter discovery — hidden GET/POST params'},
  {n:'xsser',       c:'Web',      p:'Automated XSS vulnerability detection'},
  {n:'httpx',       c:'Web',      p:'Fast HTTP probing — status codes, titles, tech'},
  {n:'sslscan',     c:'Web',      p:'SSL/TLS scanner — ciphers, certs, vulnerabilities'},
  {n:'testssl',     c:'Web',      p:'Test SSL/TLS configuration for weaknesses'},
  {n:'msfconsole',  c:'Exploit',  p:'Metasploit Framework — exploits, payloads, post-exploitation'},
  {n:'msfvenom',    c:'Exploit',  p:'Payload generator — shellcode for all platforms'},
  {n:'searchsploit',c:'Exploit',  p:'Offline Exploit-DB search for known CVEs'},
  {n:'beef-xss',    c:'Exploit',  p:'Browser Exploitation Framework via XSS hooks'},
  {n:'setoolkit',   c:'Exploit',  p:'Social Engineering Toolkit — phishing, harvesting'},
  {n:'evil-winrm',  c:'Exploit',  p:'WinRM shell for Windows remote access over port 5985'},
  {n:'impacket-psexec',  c:'Exploit', p:'Remote code execution via SMB/PsExec technique'},
  {n:'impacket-smbexec', c:'Exploit', p:'SMB shell via service creation — stealthy exec'},
  {n:'impacket-wmiexec', c:'Exploit', p:'Semi-interactive shell via WMI'},
  {n:'pwncat',      c:'Exploit',  p:'Advanced reverse shell handler with post-exploitation'},
  {n:'hydra',       c:'Password', p:'Fast network login cracker — SSH, FTP, HTTP, RDP'},
  {n:'medusa',      c:'Password', p:'Parallel brute force for network auth services'},
  {n:'ncrack',      c:'Password', p:'High-speed auth cracking tool by the Nmap team'},
  {n:'hashcat',     c:'Password', p:'World\'s fastest CPU/GPU hash cracker'},
  {n:'john',        c:'Password', p:'John the Ripper — versatile offline password cracker'},
  {n:'crunch',      c:'Password', p:'Custom wordlist generator from charset/patterns'},
  {n:'cewl',        c:'Password', p:'Wordlist generator from website content crawling'},
  {n:'cupp',        c:'Password', p:'Targeted wordlist from user profile information'},
  {n:'fcrackzip',   c:'Password', p:'Brute force ZIP file password cracker'},
  {n:'hashid',      c:'Password', p:'Identify hash types — MD5, SHA, bcrypt, NTLM'},
  {n:'ophcrack',    c:'Password', p:'Windows password cracker using rainbow tables'},
  {n:'enum4linux',  c:'Network',  p:'SMB enumeration — users, shares, groups, policies'},
  {n:'smbclient',   c:'Network',  p:'SMB client — browse and download shares'},
  {n:'smbmap',      c:'Network',  p:'SMB share enumeration and permission mapping'},
  {n:'rpcclient',   c:'Network',  p:'Query Windows info via MS-RPC — users, SIDs'},
  {n:'crackmapexec',c:'Network',  p:'SMB/WinRM lateral movement and credential spraying'},
  {n:'bloodhound',  c:'Network',  p:'AD attack path visualizer — find privesc routes'},
  {n:'ldapsearch',  c:'Network',  p:'Query LDAP/AD servers — users, groups, policies'},
  {n:'kerbrute',    c:'Network',  p:'Kerberos brute force — enumerate valid AD users'},
  {n:'impacket-getNPUsers',  c:'Network', p:'AS-REP Roasting — hashes without pre-auth'},
  {n:'impacket-getUserSPNs', c:'Network', p:'Kerberoasting — get crackable service tickets'},
  {n:'impacket-secretsdump', c:'Network', p:'Dump SAM, NTDS.dit, LSA secrets remotely'},
  {n:'responder',   c:'Network',  p:'LLMNR/NBT-NS poisoner — capture NTLMv2 hashes'},
  {n:'mitm6',       c:'Network',  p:'IPv6 MITM attack targeting Windows AD environments'},
  {n:'ettercap',    c:'Network',  p:'MITM attacks — ARP poisoning, sniffing, filtering'},
  {n:'bettercap',   c:'Network',  p:'Network attacks — ARP, WiFi, HTTPS stripping'},
  {n:'netcat',      c:'Network',  p:'TCP/UDP Swiss knife — listeners, shells, transfers'},
  {n:'socat',       c:'Network',  p:'Multipurpose relay — port forwarding, shells'},
  {n:'proxychains', c:'Network',  p:'Route TCP through proxies — pivoting and anonymity'},
  {n:'chisel',      c:'Network',  p:'Fast TCP/UDP tunnel over HTTP — firewall bypass'},
  {n:'ligolo-ng',   c:'Network',  p:'Advanced pivoting via TUN interface'},
  {n:'tcpdump',     c:'Network',  p:'CLI packet capture for raw traffic analysis'},
  {n:'wireshark',   c:'Network',  p:'GUI packet analyzer — deep protocol inspection'},
  {n:'tshark',      c:'Network',  p:'Terminal Wireshark — scripted packet analysis'},
  {n:'arpspoof',    c:'Network',  p:'ARP spoofing to redirect traffic through attacker'},
  {n:'aircrack-ng', c:'Wireless', p:'WEP/WPA/WPA2 cracking from captured handshakes'},
  {n:'airmon-ng',   c:'Wireless', p:'Enable/disable monitor mode on wireless interfaces'},
  {n:'airodump-ng', c:'Wireless', p:'Capture 802.11 frames — WPA handshake collection'},
  {n:'aireplay-ng', c:'Wireless', p:'Packet injection — deauth, ARP replay, fake auth'},
  {n:'wifite',      c:'Wireless', p:'Automated wireless attack tool — WEP, WPA, WPS'},
  {n:'reaver',      c:'Wireless', p:'WPS PIN brute force to recover WPA passphrase'},
  {n:'bully',       c:'Wireless', p:'WPS brute force attack — alternative to Reaver'},
  {n:'pixiewps',    c:'Wireless', p:'Offline WPS PIN cracking via Pixie Dust attack'},
  {n:'hcxdumptool', c:'Wireless', p:'Capture PMKID and EAPOL for offline cracking'},
  {n:'hcxtools',    c:'Wireless', p:'Convert captures to hashcat-compatible formats'},
  {n:'kismet',      c:'Wireless', p:'Wireless network detector, sniffer and IDS'},
  {n:'mimikatz',    c:'Post',     p:'Windows cred dumping — passwords, hashes, tickets'},
  {n:'empire',      c:'Post',     p:'PowerShell/Python post-exploitation C2 framework'},
  {n:'linpeas',     c:'Post',     p:'Linux PrivEsc auto-enumeration script'},
  {n:'winpeas',     c:'Post',     p:'Windows PrivEsc enumeration — misconfigs, weak perms'},
  {n:'pspy',        c:'Post',     p:'Monitor Linux processes without root — find crons'},
  {n:'lsassy',      c:'Post',     p:'Remotely dump lsass and extract credentials'},
  {n:'linenum',     c:'Post',     p:'Linux enumeration script for privilege escalation'},
  {n:'binwalk',     c:'Forensics',p:'Firmware analysis and embedded file extraction'},
  {n:'foremost',    c:'Forensics',p:'File carving — recover deleted files from images'},
  {n:'volatility3', c:'Forensics',p:'Memory forensics — analyze RAM dumps for artifacts'},
  {n:'autopsy',     c:'Forensics',p:'Digital forensics GUI — disk imaging, investigation'},
  {n:'exiftool',    c:'Forensics',p:'Read/write metadata in images, PDFs, media files'},
  {n:'steghide',    c:'Forensics',p:'Embed/extract hidden data in JPEG/BMP/WAV'},
  {n:'stegseek',    c:'Forensics',p:'Fast steghide brute forcer using wordlists'},
  {n:'zsteg',       c:'Forensics',p:'Detect LSB steganography in PNG/BMP images'},
  {n:'ghidra',      c:'Forensics',p:'NSA RE suite — decompiler and disassembler'},
  {n:'radare2',     c:'Forensics',p:'RE framework — disassembly, debugging, analysis'},
  {n:'gdb',         c:'Forensics',p:'GNU Debugger — dynamic analysis, exploit dev'},
  {n:'strings',     c:'Forensics',p:'Extract printable strings from binary files'},
  {n:'strace',      c:'Forensics',p:'Trace system calls of a running process'},
  {n:'tor',         c:'Misc',     p:'Anonymity network — route traffic through Tor'},
  {n:'openvpn',     c:'Misc',     p:'VPN client — connect to HTB/THM/lab environments'},
  {n:'openssl',     c:'Misc',     p:'Crypto toolkit — certs, encrypt, decrypt, s_client'},
  {n:'ssh',         c:'Misc',     p:'Secure shell — remote access, tunnels, port forwarding'},
  {n:'python3',     c:'Misc',     p:'Run exploits, HTTP servers, custom scripts'},
  {n:'tmux',        c:'Misc',     p:'Terminal multiplexer — split panes, persist sessions'},
  {n:'base64',      c:'Misc',     p:'Encode/decode base64 — payload obfuscation'},
  {n:'nc',          c:'Misc',     p:'Netcat — listeners, reverse shells, banner grabbing'},
  {n:'rlwrap',      c:'Misc',     p:'Add readline history to raw netcat shells'},
];

const CATS = ['All','Recon','Web','Exploit','Password','Network','Wireless','Post','Forensics','Misc'];
let activeCat = 'All';

function initTools() {
  const cf = document.getElementById('catFilter');
  CATS.forEach(c => {
    const b = document.createElement('button');
    b.className = 'cat-btn' + (c === 'All' ? ' active' : '');
    b.textContent = c;
    b.onclick = () => {
      document.querySelectorAll('.cat-btn').forEach(x => x.classList.remove('active'));
      b.classList.add('active');
      activeCat = c;
      renderTools();
    };
    cf.appendChild(b);
  });
  renderTools();
}

function renderTools() {
  const q = (document.getElementById('toolSearch').value || '').toLowerCase();
  const list = document.getElementById('toolsList');
  list.innerHTML = '';

  const filtered = KALI_TOOLS.filter(t =>
    (activeCat === 'All' || t.c === activeCat) &&
    (!q || t.n.includes(q) || t.p.toLowerCase().includes(q))
  );

  if (!filtered.length) {
    list.innerHTML = '<div class="no-results">No tools found.</div>';
    return;
  }

  const grouped = {};
  filtered.forEach(t => { (grouped[t.c] = grouped[t.c] || []).push(t); });

  Object.entries(grouped).forEach(([cat, tools]) => {
    if (activeCat === 'All') {
      const hdr = document.createElement('div');
      hdr.className = 'tool-cat-hdr';
      hdr.textContent = `── ${cat.toUpperCase()} ──`;
      list.appendChild(hdr);
    }
    tools.forEach(t => {
      const item = document.createElement('div');
      item.className = 'tool-item';
      item.innerHTML = `<div class="tool-name">${t.n}</div><div class="tool-desc">${t.p}</div>`;
      item.onclick = () => quickPrompt(`Explain ${t.n} in detail: what it does, key flags, practical examples and what to look for in the output.`);
      list.appendChild(item);
    });
  });
}

// ═══════════════════════════════════
// ACTIVITY LOG
// ═══════════════════════════════════
function logActivity(type, msg) {
  const log = document.getElementById('activityLog');
  const now = new Date().toLocaleTimeString('en-US', {hour12:false});
  const row = document.createElement('div');
  row.className = 'log-row';
  row.innerHTML = `
    <span class="log-ts">${now}</span>
    <span class="log-tag ${type}">${type}</span>
    <span class="log-text">${escapeHtml(msg)}</span>
  `;
  log.appendChild(row);
  log.scrollTop = log.scrollHeight;
}

// ═══════════════════════════════════
// TERMINAL
// ═══════════════════════════════════
let cmdHistory = [], historyIndex = -1;

function handleCmdKey(e) {
  if (e.key === 'Enter') { runCommand(); return; }
  if (e.key === 'ArrowUp') {
    e.preventDefault();
    if (historyIndex < cmdHistory.length - 1) {
      historyIndex++;
      document.getElementById('cmdInput').value = cmdHistory[cmdHistory.length - 1 - historyIndex];
    }
  }
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    if (historyIndex > 0) {
      historyIndex--;
      document.getElementById('cmdInput').value = cmdHistory[cmdHistory.length - 1 - historyIndex];
    } else {
      historyIndex = -1;
      document.getElementById('cmdInput').value = '';
    }
  }
}

async function runCommand() {
  const input = document.getElementById('cmdInput');
  const command = input.value.trim();
  if (!command) return;

  cmdHistory.push(command);
  historyIndex = -1;
  input.value = '';

  const out = document.getElementById('termOutput');
  out.querySelector('.term-welcome')?.remove();

  const entry = document.createElement('div');
  entry.className = 'term-entry';
  entry.innerHTML = `<div class="term-cmd">${escapeHtml(command)}</div><div class="term-running">running...</div>`;
  out.appendChild(entry);
  out.scrollTop = out.scrollHeight;

  logActivity('cmd', command);
  document.getElementById('runBtn').disabled = true;

  try {
    const resp = await fetch('/api/run', {
      method:'POST',
      headers: authHeaders(),
      body: JSON.stringify({ command })
    });
    const data = await resp.json();

    if (data.error) {
      entry.innerHTML = `<div class="term-cmd">${escapeHtml(command)}</div><div class="term-out term-err">⚠ ${escapeHtml(data.error)}</div>`;
      logActivity('err', data.error);
    } else {
      const rc = data.returncode !== undefined
        ? ` <span style="color:rgba(0,200,255,0.3);font-size:0.72rem">[exit ${data.returncode}]</span>` : '';
      entry.innerHTML = `<div class="term-cmd">${escapeHtml(command)}${rc}</div><div class="term-out">${escapeHtml(data.output)}</div>`;
      const lines = data.output.trim().split('\n').length;
      logActivity('ok', `exit ${data.returncode} · ${lines} line(s) of output`);
    }
  } catch(e) {
    entry.innerHTML = `<div class="term-cmd">${escapeHtml(command)}</div><div class="term-out term-err">⚠ Connection error: ${escapeHtml(e.message)}</div>`;
    logActivity('err', 'Connection error: ' + e.message);
  }

  document.getElementById('runBtn').disabled = false;
  out.scrollTop = out.scrollHeight;
  input.focus();
}

// ═══════════════════════════════════
// CHAT
// ═══════════════════════════════════
const sessionId = 'session_' + Date.now();
let isLoading = false;

function getModel() { return 'openrouter/free'; }
function timestamp() { return new Date().toLocaleTimeString('en-US', {hour12:false}); }

function addMessage(role, content) {
  const msgs = document.getElementById('messages');
  msgs.querySelector('.welcome')?.remove();

  const div = document.createElement('div');
  div.className = `msg ${role === 'user' ? 'user-msg' : 'ai-msg'}`;

  const icon  = role === 'user' ? '▶' : '◈';
  const label = role === 'user' ? 'OPERATOR' : 'CALCIUM';
  const model = role === 'ai'
    ? `<span style="color:rgba(0,200,255,0.25);font-weight:400"> · ${getModel().split('/')[1]?.split(':')[0] || 'AI'}</span>` : '';

  const bodyHTML = role === 'user'
    ? escapeHtml(content).replace(/\n/g,'<br>')
    : renderMarkdown(content);

  div.innerHTML = `
    <div class="msg-icon">${icon}</div>
    <div class="msg-inner">
      <div class="msg-meta">[${timestamp()}] ${label}${model}</div>
      <div class="msg-body">${bodyHTML}</div>
    </div>
  `;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;

  div.querySelectorAll('pre code').forEach(el => {
    hljs.highlightElement(el);
    const pre = el.parentElement;
    pre.style.position = 'relative';
    const btn = document.createElement('button');
    btn.className = 'copy-btn';
    btn.textContent = 'COPY';
    btn.onclick = () => {
      navigator.clipboard.writeText(el.textContent);
      btn.textContent = 'COPIED!';
      setTimeout(() => btn.textContent = 'COPY', 1500);
    };
    pre.appendChild(btn);
  });
}

function addTyping() {
  const msgs = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = 'msg ai-msg';
  div.id = 'typing-indicator';
  div.innerHTML = `
    <div class="msg-icon">◈</div>
    <div class="msg-inner">
      <div class="msg-meta">[${timestamp()}] CALCIUM</div>
      <div class="msg-body"><div class="typing"><span></span><span></span><span></span></div></div>
    </div>
  `;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

function removeTyping() { document.getElementById('typing-indicator')?.remove(); }

function renderMarkdown(text) {
  try { return marked.parse(text); }
  catch { return escapeHtml(text).replace(/\n/g,'<br>'); }
}

function escapeHtml(str) {
  return String(str)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

async function sendMessage(content = null) {
  if (isLoading) return;
  const input = document.getElementById('userInput');
  const message = content || input.value.trim();
  if (!message) return;

  input.value = '';
  addMessage('user', message);
  logActivity('ai', 'Query sent: ' + message.substring(0,60) + (message.length > 60 ? '...' : ''));
  isLoading = true;
  document.getElementById('sendBtn').disabled = true;
  addTyping();

  try {
    const resp = await fetch('/api/chat', {
      method:'POST',
      headers: authHeaders(),
      body: JSON.stringify({ message, session_id: sessionId, model: getModel() })
    });
    const data = await resp.json();
    removeTyping();
    if (data.error) {
      addMessage('ai', `⚠️ **Error:** ${data.error}`);
      logActivity('err', 'AI error: ' + data.error);
    } else {
      addMessage('ai', data.reply);
      logActivity('ai', 'AI responded · ' + data.reply.length + ' chars');
    }
  } catch(e) {
    removeTyping();
    addMessage('ai', `⚠️ **Connection error:** ${e.message}`);
    logActivity('err', 'AI connection error: ' + e.message);
  }

  isLoading = false;
  document.getElementById('sendBtn').disabled = false;
}

function quickPrompt(text) {
  document.getElementById('userInput').value = text;
  sendMessage();
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

async function clearSession() {
  await fetch('/api/clear', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ session_id: sessionId })
  });
  document.getElementById('messages').innerHTML = `<div class="welcome"><h2>Session Cleared</h2><p>Start a new session.</p></div>`;
  document.getElementById('termOutput').innerHTML = `<div class="term-running">Terminal cleared.</div>`;
  document.getElementById('activityLog').innerHTML = '';
  logActivity('info', 'Session cleared.');
}

async function exportSession() {
  const resp = await fetch('/api/export', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ session_id: sessionId })
  });
  const data = await resp.json();
  if (data.file) addMessage('ai', `✅ Session exported to: \`${data.file}\``);
}


// ═══════════════════════════════════
// AUTH
// ═══════════════════════════════════
const TOKEN_KEY = 'calcium_token';
function getToken()    { return localStorage.getItem(TOKEN_KEY) || ''; }
function getUsername() { return localStorage.getItem('calcium_user') || 'USER'; }
function getRole()     { return localStorage.getItem('calcium_role') || 'user'; }
function authHeaders() { return { 'Content-Type': 'application/json', 'X-Auth-Token': getToken() }; }

async function checkAuth() {
  const token = getToken();
  if (!token) { window.location.href = '/login'; return; }
  try {
    const resp = await fetch('/api/auth/verify', { headers: { 'X-Auth-Token': token } });
    const data = await resp.json();
    if (!data.valid) { localStorage.clear(); window.location.href = '/login'; return; }
    // Always update role/username from server (source of truth)
    localStorage.setItem('calcium_role', data.role || 'user');
    localStorage.setItem('calcium_user', data.username || 'USER');
    // Update header status
    const statusEl = document.querySelector('.status-badge span');
    if (statusEl) statusEl.textContent = (data.username || 'USER').toUpperCase() + ' · ONLINE';
    // Show buttons
    document.getElementById('logoutBtn').style.display = '';
    if (data.role === 'admin') document.getElementById('adminBtn').style.display = '';
  } catch(e) {
    // If server unreachable, fall back to localStorage
    document.getElementById('logoutBtn').style.display = '';
    if (getRole() === 'admin') document.getElementById('adminBtn').style.display = '';
  }
}

async function doLogout() {
  try {
    await fetch('/api/auth/logout', { method:'POST', headers:{ 'X-Auth-Token': getToken() } });
  } catch(e) {}
  localStorage.clear();
  window.location.href = '/login';
}

// ── Admin modal ───────────────────────────────────────────────────────────────
function openAdmin() {
  document.getElementById('adminModal').classList.add('open');
  loadAdminUsers();
}
function closeAdmin() {
  document.getElementById('adminModal').classList.remove('open');
}

async function loadAdminUsers() {
  const tbody = document.getElementById('adminUsersList');
  try {
    const resp = await fetch('/api/auth/users', { headers: { 'X-Auth-Token': getToken() } });
    const data = await resp.json();
    if (data.error || !data.users) {
      tbody.innerHTML = `<tr><td colspan="4" style="color:var(--red);text-align:center;padding:12px">${data.error || 'Failed to load'}</td></tr>`;
      return;
    }
    const me = getUsername();
    tbody.innerHTML = data.users.map(u => `
      <tr>
        <td style="color:var(--cyan);font-weight:600">${u.username}</td>
        <td><span class="utag utag-${u.role}">${u.role}</span></td>
        <td style="color:var(--dim);font-size:0.7rem">${u.last_login ? u.last_login.slice(0,16).replace('T',' ') : 'Never'}</td>
        <td>${u.username !== me
          ? `<button class="udel" onclick="adminDeleteUser('${u.username}')">DEL</button>`
          : `<span style="color:var(--dim);font-size:0.65rem">(you)</span>`}</td>
      </tr>
    `).join('');
  } catch(e) {
    tbody.innerHTML = `<tr><td colspan="4" style="color:var(--red);text-align:center;padding:12px">Connection error</td></tr>`;
  }
}

async function adminCreateUser() {
  const username = document.getElementById('muUsername').value.trim();
  const password = document.getElementById('muPassword').value;
  const role     = document.getElementById('muRole').value;
  const msg      = document.getElementById('adminModalMsg');

  if (!username || !password) {
    msg.className = 'modal-msg err'; msg.textContent = 'Username and password required'; return;
  }
  try {
    const resp = await fetch('/api/auth/users/create', {
      method:'POST', headers: authHeaders(),
      body: JSON.stringify({ username, password, role })
    });
    const data = await resp.json();
    msg.className = `modal-msg ${data.success ? 'ok' : 'err'}`;
    msg.textContent = data.message || data.error;
    if (data.success) {
      document.getElementById('muUsername').value = '';
      document.getElementById('muPassword').value = '';
      loadAdminUsers();
    }
  } catch(e) { msg.className='modal-msg err'; msg.textContent='Connection error'; }
}

async function adminDeleteUser(username) {
  if (!confirm(`Delete user "${username}"? This cannot be undone.`)) return;
  const msg = document.getElementById('adminModalMsg');
  try {
    const resp = await fetch('/api/auth/users/delete', {
      method:'POST', headers: authHeaders(),
      body: JSON.stringify({ username })
    });
    const data = await resp.json();
    msg.className = `modal-msg ${data.success ? 'ok' : 'err'}`;
    msg.textContent = data.message || data.error;
    if (data.success) loadAdminUsers();
  } catch(e) { msg.className='modal-msg err'; msg.textContent='Connection error'; }
}

checkAuth();

initTools();
</script>

<!-- ADMIN MODAL -->
<div class="modal-overlay" id="adminModal" onclick="if(event.target===this)closeAdmin()">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title">⚙ User Management</div>
      <button class="modal-close" onclick="closeAdmin()">✕ CLOSE</button>
    </div>
    <div class="modal-body">

      <div class="modal-section">
        <div class="modal-section-title">Create New User</div>
        <div class="modal-msg" id="adminModalMsg"></div>
        <div class="modal-row">
          <input class="modal-input" type="text" id="muUsername" placeholder="Username">
          <input class="modal-input" type="password" id="muPassword" placeholder="Password">
          <select class="modal-select" id="muRole">
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
          <button class="modal-btn" onclick="adminCreateUser()">ADD</button>
        </div>
      </div>

      <div class="modal-section">
        <div class="modal-section-title">All Users</div>
        <table class="user-table">
          <thead>
            <tr>
              <th>Username</th>
              <th>Role</th>
              <th>Last Login</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="adminUsersList">
            <tr><td colspan="4" style="color:var(--dim);text-align:center;padding:12px">Loading...</td></tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>
</div>

</body>
</html>
